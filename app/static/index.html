<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transcoder Debug UI</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, Noto Sans; margin: 0; color: #111; }
    header { background: #0f172a; color: #fff; padding: 14px 18px; display: flex; align-items: center; gap: 14px;}
    header h1 { margin: 0; font-size: 18px; }
    main { display: grid; grid-template-columns: 420px 1fr; gap: 16px; padding: 16px; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    button { background: #2563eb; color: #fff; border: none; padding: 8px 12px; border-radius: 10px; cursor:pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: #6b7280; font-size: 12px; }
    .log { font-family: ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap; background: #0b1020; color:#e5e7eb; height: 48vh; overflow:auto; padding:10px; border-radius:10px; }
    .job { border-bottom: 1px dashed #e5e7eb; padding: 8px 0; }
    .name { font-weight: 600; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .bar { width: 100%; height: 10px; background: #f3f4f6; border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; background: linear-gradient(90deg,#22c55e, #86efac); width: 0%; transition: width .15s linear; }
    .tiny { font-size: 12px; color: #374151; }
    .grid { display:grid; gap:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Transcoder Debug UI</h1>
    <div id="cfg" class="muted"></div>
    <div style="margin-left:auto; display:flex; gap:10px">
      <button id="scanBtn">Scan now</button>
      <button id="stopBtn" style="background:#ef4444">Stop</button>
    </div>
  </header>
  <main>
    <section class="panel">
      <h3>Jobs</h3>
      <div id="jobs" class="grid"></div>
    </section>
    <section class="panel">
      <h3>Logs</h3>
      <div id="log" class="log"></div>
    </section>
  </main>
  <script>
    const logEl = document.getElementById('log');
    const jobsEl = document.getElementById('jobs');
    const scanBtn = document.getElementById('scanBtn');
    const stopBtn = document.getElementById('stopBtn');
    const cfgEl = document.getElementById('cfg');

    function humanTime(s){
      if(s == null || !isFinite(s)) return '—';
      s = Math.max(0, Math.round(s));
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
      return (h? h+':':'') + String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
    }

    const jobs = new Map();
    function ensureJob(file){
      if(!jobs.has(file)){
        const row = document.createElement('div');
        row.className = 'job';
        row.innerHTML = `
          <div class="name" title="\${file}">\${file}</div>
          <div class="row">
            <div class="bar"><div></div></div>
            <div class="tiny"><span class="pct">0%</span> • <span class="spd">—</span> • ETA <span class="eta">—</span></div>
          </div>`;
        jobsEl.appendChild(row);
        jobs.set(file, row);
      }
      return jobs.get(file);
    }

    function updateJob(msg){
      const row = ensureJob(msg.file);
      const bar = row.querySelector('.bar > div');
      const pct = row.querySelector('.pct');
      const spd = row.querySelector('.spd');
      const eta = row.querySelector('.eta');
      const p = msg.percent != null ? Math.min(100, Math.max(0, msg.percent)) : 0;
      bar.style.width = p.toFixed(1) + '%';
      pct.textContent = p.toFixed(1)+'%';
      spd.textContent = msg.speed ? msg.speed.toFixed(2)+'x' : '—';
      eta.textContent = humanTime(msg.eta);
      if(msg.stage === 'end'){ pct.textContent = '100%'; bar.style.width = '100%'; }
    }

    function appendLog(text){
      const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 30;
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${text}
`;
      if(atBottom){ logEl.scrollTop = logEl.scrollHeight; }
    }

    async function loadCfg(){
      const res = await fetch('/config'); const cfg = await res.json();
      cfgEl.textContent = \`\${cfg.target_dir} • CRF \${cfg.crf} • \${cfg.use_nvenc? 'NVENC':'x264'} • \${cfg.audio_bitrate}\`;
    }

    scanBtn.onclick = async ()=>{
      scanBtn.disabled = true;
      await fetch('/scan',{method:'POST'});
      setTimeout(()=>scanBtn.disabled=false, 1000);
    };
    stopBtn.onclick = async ()=>{ await fetch('/stop',{method:'POST'}); };

    loadCfg();

    const wsProto = location.protocol === 'https:' ? 'wss':'ws';
    const ws = new WebSocket(\`\${wsProto}://\${location.host}/ws\`);
    ws.onmessage = (ev)=>{
      try{
        const m = JSON.parse(ev.data);
        if(m.type === 'log'){ appendLog(m.message); }
        else if(m.type === 'progress'){ updateJob(m); }
        else if(m.type === 'done'){ appendLog(\`\${m.ok?'[ok]':'[error]'} \${m.file}\`); }
      }catch(e){}
    };
    ws.onopen = ()=> appendLog('Connected.');
    ws.onclose = ()=> appendLog('Disconnected.');
  </script>
</body>
</html>
